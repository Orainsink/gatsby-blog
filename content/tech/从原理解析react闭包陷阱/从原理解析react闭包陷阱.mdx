---
categories: tech
description: reactçš„æ–°å®˜æ–¹æ–‡æ¡£å·²ç»å°†useEffectEventå†™ä¸ºæ¨èçš„è§£å†³hooksä¾èµ–çš„æ–¹æ¡ˆï¼Œæœ¬æ–‡ä»åŸç†åˆ†æï¼Œä»‹ç»è¿™ä¸ªhookä¸ºä»€ä¹ˆä¼—æœ›æ‰€å½’ä»¥åŠä»–æ‰€è§£å†³çš„reactç—›ç‚¹
date: 2023-03-17 11:35:58
title: ä»åŸç†è§£æreacté—­åŒ…é™·é˜±
tags: [react, js]
---

> è¯¦ç»†ä»‹ç» Memorization hooks å‡ºç°é—­åŒ…é™·é˜±çš„åŸå› å’Œåº”å¯¹æ–¹æ³•ã€‚ä»¥åŠä»‹ç» react æœ€æ–°çš„å°šå¤„äºææ¡ˆé˜¶æ®µçš„ hook
>
> æˆ‘çœ‹äº†å¾ˆå¤šè°ˆè®ºé—­åŒ…é™·é˜±çš„æ–‡ç« ï¼Œä½†å¤§å¤šæ•°éƒ½æ˜¯æµ…å°è¾„æ­¢ï¼Œä¸”ç»å¤§éƒ¨åˆ†éƒ½æ˜¯å¤åˆ¶ç²˜è´´ï¼Œå¾ˆå°‘æœ‰æ·±å…¥åˆ°é—­åŒ…åŸç†çš„ï¼Œå³ä¾¿æœ‰æ¶‰åŠåˆ°çš„ï¼Œä½œè€…è‡ªå·±ä¹Ÿå†™çš„äº‘é‡Œé›¾é‡Œï¼Œä¸çŸ¥æ‰€äº‘ã€‚

## ä½•ä¸º React çš„é—­åŒ…é™·é˜±

ä¸¤ç§å¸¸è§å‡ºç°é—­åŒ… bug çš„ä»£ç 

**setInterval / setTimeout**

```jsx live name=å®šæ—¶å™¨
function Timer() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const handleCount = () => {
      setCount(count + 1);
    };
    setInterval(handleCount, 500);
  }, []);

  return (
    <div>
      <p>Count: {count}</p>
    </div>
  );
}
```

```jsx live name=ç»‘å®šäº‹ä»¶
function EventListener() {
  const [count, setCount] = useState(0);
  const countRef = useRef(null);

  useEffect(() => {
    const handleCount = () => {
      setCount(count + 1);
    };
    countRef.current?.addEventListener('click', handleCount);
  }, []);

  return (
    <div>
      <div>Count: {count}</div>
      <button ref={countRef}>Count + 1</button>
    </div>
  );
}
```

è¿™ä¸¤æ®µä»£ç åœ¨è§¦å‘å®šæ—¶å™¨æˆ–ç‚¹å‡»æŒ‰é’®è¿‡å, count å°†æ°¸è¿œéƒ½æ˜¯ 1ã€‚ï¼ˆä¸Šé¢çš„ Live Editor æ˜¯å¯ç¼–è¾‘çš„ï¼Œå¯ä»¥è‡ªå·±è°ƒè¯•ä¸€ä¸‹ã€‚ï¼‰

ChatGPT ç»™çš„é—­åŒ…é™·é˜±çš„æ–‡å­—æè¿°ï¼šåœ¨ react é’©å­ä¸­å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°(`handleCount`)å¹¶å°†å…¶ä½œä¸ºå›è°ƒå‡½æ•°ä¼ é€’ç»™å¦ä¸€ä¸ªå‡½æ•°æˆ–ç»„ä»¶æ—¶ï¼Œç”±äº JavaScript çš„[é—­åŒ…ç‰¹æ€§](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Closures)ï¼Œè¿™ä¸ªå‡½æ•°å°†ä¼šæ•è·å®ƒæ‰€åœ¨çš„å‡½æ•°ä½œç”¨åŸŸä¸­çš„å˜é‡ï¼Œè€Œä¸æ˜¯ä¼ å…¥çš„ props æˆ– stateã€‚

æ–‡å­—æè¿°é‡Œæœ‰ä¸¤ä¸ªå…³é”®è¯ â€œé—­åŒ…ç‰¹æ€§â€ å’Œ â€œæ•è·å˜é‡â€ã€‚å¦‚æœä½ ä¸èƒ½æ·±å…¥ç†è§£è¿™ä¸¤ä¸ªä¸œè¥¿ï¼Œé‚£çœ‹å®Œæ–‡å­—æè¿°ç­‰äºè¿˜æ˜¯å•¥éƒ½ä¸æ‡‚ã€‚

GPT æ²¡æœ‰è§£é‡Šæ¸…æ¥š(å¥½é™©ï¼Œå·®ç‚¹è¢« AI æ›¿ä»£æ‰äº† ğŸ”ğŸš)ã€‚

## é—­åŒ…å’Œè¿‡æ—¶é—­åŒ…(stale closure)

> [Understading stale closures in javascript](https://dilshankelsen.com/understanding-stale-closures-in-javascript/)
>
> [JavaScript ä¸­å˜é‡åˆ°åº•æ˜¯å­˜å‚¨åœ¨ã€Œæ ˆã€è¿˜æ˜¯ã€Œå †ã€ä¸Šï¼Ÿ](https://zhuanlan.zhihu.com/p/362219811)

ç¬¬ä¸€æ­¥ï¼Œå…ˆææ‡‚é—­åŒ…(clousure)ä»¥åŠè¿‡æ—¶é—­åŒ…(stale clousure)

### é—­åŒ…

> å¦‚æœä½ è¿˜ä¸çŸ¥é“ä»€ä¹ˆæ˜¯é—­åŒ…ï¼Œå…ˆå»è¡¥æ‰«ç›²çŸ¥è¯† [é—­åŒ…åŸºç¡€çŸ¥è¯†](https://zh.javascript.info/closure)
>
> æ·±å…¥äº†è§£é—­åŒ…éœ€è¦çŸ¥é“ï¼šä½œç”¨åŸŸé“¾ï¼Œæ‰§è¡Œä¸Šä¸‹æ–‡ï¼ŒJS åƒåœ¾å›æ”¶å’Œè¯æ³•ç¯å¢ƒçš„æ¦‚å¿µ

é—­åŒ…æ˜¯å¾ˆå¤šè¯­è¨€çš„éš¾ç‚¹ï¼Œåªè¨€ç‰‡è¯­è‚¯å®šè¯´ä¸æ¸…æ¥šã€‚è¦ä»å¤´åˆ°å°¾è¯´çš„è¯ï¼Œæˆ‘è‡ªå·±ä¹Ÿæ²¡æœ‰è‡ªä¿¡èƒ½è§£é‡Šæ¸…æ¥šã€‚

é—­åŒ…å³æ˜¯åœ¨å‡½æ•°å†…å¯ä»¥è®¿é—®å‡½æ•°å¤–å˜é‡çš„å‡½æ•°ï¼Œæ˜¯å‡½æ•°ä¸è¯æ³•ç¯å¢ƒçš„ç»“åˆã€‚

è¯æ³•ç¯å¢ƒæ˜¯ä¸€ä¸ªæ— æ³•è®¿é—®åˆ°çš„å¯¹è±¡ï¼Œä»å¯¹è±¡çš„è§’åº¦æ¥ç†è§£é—­åŒ…ä¼šæ¯”è¾ƒæŠ½è±¡æ™¦æ¶©ã€‚

é—­åŒ…æœ¬æ„æ˜¯ä¸€ç§è®©å‡½æ•°å¯ä»¥è®¿é—®å¤–éƒ¨å‡½æ•°ä½“å†…çš„å˜é‡çš„æ‰‹æ®µï¼Œå†…å­˜å¾—ä¸åˆ°é‡Šæ”¾åªæ˜¯å…¶å‰¯ä½œç”¨ï¼ˆå¹¶ä¸”é€šå¸¸æœ‰å®³ï¼‰ã€‚ä½†ä»å†…å­˜å’Œ GC çš„è§’åº¦æ¥ç†è§£é—­åŒ…åˆšå¥½ä¼šæ›´åŠ å®¹æ˜“ç†è§£è¿‡æ—¶é—­åŒ…çš„äº§ç”ŸåŸç†ã€‚

### é—­åŒ…çš„å€¼æ•è·

å½“ä½ å»æ‰¾ç½‘ä¸Šçš„èµ„æ–™çš„æ—¶å€™ï¼Œä¼šå‘ç°å¤§éƒ¨åˆ†äººå¯¹ä¿å­˜å¤–éƒ¨å¼•ç”¨çš„æè¿°æ­¢æ­¥äº`capture`ï¼Œå¹¶æ²¡æœ‰è¯´æ˜è¿™ä¸ª`capture`ç©¶ç«Ÿæ˜¯å¦‚ä½•å®ç°çš„ã€‚

æ˜¯å€¼çš„æ‹·è´è¿˜æ˜¯è¯æ³•ç¯å¢ƒå¯¹è±¡å¼•ç”¨åœ°å€çš„æ‹·è´ï¼Ÿå­˜åœ¨å“ªé‡Œï¼ŸåŒä¸€å‡½æ•°çš„å¦‚æœè¿”å›å¤šä¸ªé—­åŒ…ï¼Œè¿™äº›é—­åŒ…`capture`çš„å€¼ä¼šäº’ç›¸å½±å“è¿˜æ˜¯å„ç®¡å„çš„ï¼Ÿå¦‚ä½•é‡Šæ”¾ï¼Ÿæˆ‘ä»¬æœ‰å¿…è¦ææ‡‚è¿™ä¸ªé—®é¢˜ï¼Œå¦åˆ™æ— æ³•å®Œå…¨ç†è§£è¿‡æ—¶é—­åŒ…çš„æ‰€æœ‰åœºæ™¯ã€‚ä¸‹é¢å°±å›ç­”è¿™äº›é—®é¢˜ã€‚

1. æ˜¯å€¼çš„æ‹·è´è¿˜æ˜¯è¯æ³•ç¯å¢ƒå¯¹è±¡å¼•ç”¨åœ°å€çš„æ‹·è´ï¼Ÿ

é—­åŒ…çš„å®ç°ä¾èµ–äºå‡½æ•°å¯¹è±¡çš„[éšè—å±æ€§](https://tc39.es/ecma262/#sec-ecmascript-function-objects)`[[Environment]]`, è¿™ä¸ªå±æ€§å‚¨å­˜äº†å‡½æ•°å£°æ˜æ—¶çš„å¤–éƒ¨è¯æ³•ç¯å¢ƒçš„å¼•ç”¨åœ°å€(ç¯å¢ƒè®°å½•)ã€‚è¯¥å±æ€§æ— æ³•è¯»å–å’Œä¿®æ”¹ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¼–è¯‘å™¨(V8)å®ç°çš„`[[Scopes]]`ä½œç”¨åŸŸé“¾å±æ€§ä¸­çš„`Closure`æ¥è§‚å¯Ÿã€‚
æ‰€ä»¥ç¬¬ä¸€ä¸ªé—®é¢˜æœ‰äº†ç­”æ¡ˆï¼š`capture`æ•è·çš„æ˜¯å‡½æ•°å£°æ˜æ—¶çš„è¯æ³•ç¯å¢ƒ(å¯¹è±¡)çš„å¼•ç”¨åœ°å€ï¼Œè€Œä¸æ˜¯æ–°å¼€è¾Ÿä¸€ç‰‡å†…å­˜æŠŠå¼•ç”¨åˆ°çš„å€¼å¤åˆ¶è¿›å»ã€‚é€šè¿‡`[[scope]]`è§‚å¯Ÿå¯ä»¥çœ‹åˆ°å¦‚ä¸‹(è¯¥å›¾ç‰‡æ˜¯è¿‡æ—¶é—­åŒ…çš„ä¾‹å­ï¼Œå°†åœ¨ç´§æ¥çš„æ®µè½é‡Œè¯¦ç»†è§£é‡Š)
![closure-debug1](./closure-debug1.png)
å¯ä»¥çœ‹åˆ°`[[Scopes]]`å†…æœ‰ä¸€ä¸ª`Closure(App)`

2. å‚¨å­˜åœ¨å“ªé‡Œï¼Ÿ

ä¸Šé¢å…¶å®å·²ç»å›ç­”äº†ï¼Œè¯æ³•ç¯å¢ƒçš„å¼•ç”¨è¢«ä¿å­˜åœ¨äº†é—­åŒ…å‡½æ•°å¯¹è±¡çš„éšè—å±æ€§`[[Enviroment]]`å†…

3. åŒä¸€å‡½æ•°è¿”å›å¤šä¸ªé—­åŒ…çš„æƒ…å†µæ˜¯å¦‚ä½•çš„ï¼Ÿ

è¿™ä¸ªå…¶å®å¯ä»¥ä»å›ç­” 1 çš„æˆªå›¾é‡Œçœ‹åˆ°ã€‚è¯¥`App`å‡½æ•°ä»¥æ•°ç»„å¯¹è±¡çš„å½¢å¼è¿”å›äº†ä¸¤ä¸ªé—­åŒ…å‡½æ•°ã€‚`log`åªå¼•ç”¨äº†`message`ï¼Œä½†æ˜¯å…¶`[[Scopes]]`å±æ€§å†…çš„`Closure`å´æœ‰`count: 2`ã€‚
åŒæ ·ï¼Œæ‰“å°`increment`ä¼šå‘ç°å…¶`Closure`ä¸­æœ‰`message: "Count is 0"`
æ‰€ä»¥ç»“è®ºæ˜¯ï¼Œå¦‚æœåŒä¸€å‡½æ•°è¿”å›çš„å¤šä¸ªé—­åŒ…ï¼Œä»–ä»¬`[[Enviroment]]`ä¸­å‚¨å­˜çš„æ˜¯åŒä¸€ä¸ªè¯æ³•ç¯å¢ƒçš„å¼•ç”¨åœ°å€ã€‚

4. å¦‚ä½•é‡Šæ”¾ï¼Ÿ

GC ä¼šå›æ”¶æ‰æ²¡æœ‰è¢«å¼•ç”¨çš„å˜é‡ï¼Œåªè¦è¿˜æœ‰ä½œç”¨åŸŸå¼•ç”¨è¯¥è¯æ³•ç¯å¢ƒï¼Œé‚£å…¶ä¸­çš„å˜é‡å°±ä¸ä¼šè¢«å›æ”¶ã€‚
åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå“ªæ€•æˆ‘ä»¬å°†`log`æ‰‹åŠ¨æ ‡è®°ä¸ºæ¸…é™¤ï¼š`log = null`ï¼Œ`Closure(App)`ä¸­çš„å˜é‡å°†å› ä¸º`increment`çš„å¼•ç”¨è€Œä¸€ç›´å­˜åœ¨äºå†…å­˜ä¸­ã€‚ç”±äºé—­åŒ…äº§ç”Ÿäºç¼–è¯‘é˜¶æ®µï¼Œå¼•ç”¨`message`çš„é—­åŒ…å‡½æ•°`log`è™½ç„¶å·²ç»è¢«æ¸…é™¤äº†ï¼Œä½†å´æ²¡æœ‰ä»»ä½•æœºåˆ¶å°†`message: "Count is 0"`åˆ é™¤ï¼Œè¿™å°±å®¹æ˜“å¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Œå‡å¦‚è¿™ä¸ª`message`æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„å¯¹è±¡ï¼Œé‚£è¿™ä¸ªå¯¹è±¡å ç”¨çš„å†…å­˜å°±ä¸ä¼šè¢«å›æ”¶ï¼Œå¯èƒ½ä¼šé€ æˆå†…å­˜æ³„æ¼ã€‚
åªæœ‰å½“`increment`ä¹Ÿè¢«æ ‡è®°ä¸ºæ¸…é™¤çš„æ—¶å€™ï¼Œ`Closure(App)`ä¸­çš„å˜é‡æ‰ä¼šè¢« GC å›æ”¶ã€‚
![ä¸ä¼šæ¸…é™¤](./closure-not-clear.png)

### å¤ç°è¿‡æ—¶é—­åŒ…

```jsx name=staleClosure
function App() {
  let count = 0;

  function increment() {
    count = count + 1;
    console.log(count);
  }

  let message = `Count is ${count}`;

  function log() {
    console.log(message);
  }

  return [increment, log];
}

const [increment, log] = App();
increment();
increment();
log();
```

çŒœçŒœ`log()`æ‰§è¡Œç»“æœæ˜¯ä»€ä¹ˆï¼Ÿ

ä¸æ˜¯ 2ï¼Œè€Œæ˜¯ 0

```shell name=output
1
2
Count is 0
```

ğŸ” åˆ†æä¸Šé¢çš„ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹(å£è¯­åŒ–ï¼Œå¿½ç•¥å˜é‡æå‡)ï¼š

1. æ‰§è¡Œ`App`å‡½æ•°
2. å£°æ˜å±€éƒ¨å˜é‡`count`ï¼Œåˆ†é…å†…å­˜ï¼Œå­˜å…¥å€¼`0`
3. å£°æ˜å‡½æ•°`increment`ï¼Œåœ¨å‡½æ•°å†…å¼•ç”¨`count`ï¼Œå½¢æˆé—­åŒ…ï¼Œåœ¨ç¯å¢ƒè®°å½•é‡Œå­˜å…¥`App`è¯æ³•ç¯å¢ƒçš„å¼•ç”¨
4. å£°æ˜å±€éƒ¨å˜é‡`message`ï¼Œåˆ†é…å†…å­˜ï¼Œå­˜å…¥å€¼`"Count is 0"`
5. å£°æ˜å‡½æ•°`log`ï¼Œåœ¨å‡½æ•°å†…å¼•ç”¨`message`ï¼Œå½¢æˆé—­åŒ…
6. å…¨å±€ä½œç”¨åŸŸä»¥è§£æ„çš„æ–¹å¼å£°æ˜`increment`å’Œ`log`ä¸¤ä¸ªå˜é‡ï¼Œåˆ†åˆ«æ¥å‚¨å­˜ä»å‡½æ•°`App` return çš„ä¸¤ä¸ªå‡½æ•°çš„å¼•ç”¨åœ°å€
7. `App`æ‰§è¡Œå®Œæ¯•ï¼Œå…¶å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡å‡ºæ ˆé”€æ¯ï¼Œä½†è¯æ³•ç¯å¢ƒè¢«é—­åŒ…å¼•ç”¨ï¼Œé¿å…è¢« GCã€‚éœ€è¦æ³¨æ„çš„æ˜¯å¹¶ä¸æ˜¯æ•´ä¸ªè¯æ³•ç¯å¢ƒè¢«ä¿ç•™ï¼Œè€Œæ˜¯åªä¿ç•™äº†ç¼–è¯‘é˜¶æ®µè¢«å¼•ç”¨çš„`count`å’Œ`message`
8. æ‰§è¡Œ`increment`, ç›´æ¥ä¿®æ”¹`count`çš„å€¼ä¸º 1
9. æ‰§è¡Œ`log`ï¼Œç›´æ¥æ‰“å°`message`çš„å€¼ä¸º`"Count is 0"`

![closure1](./closure1.png)

`App` å‡½æ•°åœ¨æ‰§è¡Œå®Œè¿‡åå…¶å†…éƒ¨çš„å±€éƒ¨å˜é‡å°±ä¼šè¢« GC å›æ”¶ï¼Œä½†`count` å’Œ `message`ç”±äºåˆ†åˆ«è¢«`increment`å’Œ`log`æ‰€å¼•ç”¨ï¼Œè¢«é—­åŒ…æ•è·ï¼Œä¼šä¸€ç›´å­˜åœ¨äºé—­åŒ…å †å†…å­˜(`Closure(App)`)ä¸­ã€‚

å‡½æ•°`increment`ç›´æ¥å¼•ç”¨å¹¶ä¿®æ”¹`count`, æ‰€ä»¥æ‰§è¡Œä¸¤æ¬¡`increment()`éƒ½å¯ä»¥æ­£å¸¸æ‰“å°`count`çš„å€¼ã€‚

`log`æ‰“å°å‡ºæ—§å€¼çš„åŸå› æ˜¯åœ¨`App`æ‰§è¡Œå®Œæ¯•è¿‡åï¼Œè¯¥å‡½æ•°æ‰§è¡Œä¸Šä¸‹æ–‡å·²ç»å‡ºæ ˆé”€æ¯äº†ï¼Œé—­åŒ…å†…çš„`message`å’Œ`count`å·²ç»æ²¡æœ‰ä»»ä½•å…³ç³»äº†ã€‚`increment`åœ¨é—­åŒ…ä¸­ä¿®æ”¹äº†`count`çš„å€¼ï¼Œä½†å¹¶ä¸ä¼šå½±å“`message`ã€‚æ‰“å°å‡ºæ¥çš„è¿˜æ˜¯`App`åˆå§‹åŒ–çš„æ—¶å€™çš„å€¼

**ä¿®æ­£è¿‡åçš„ä»£ç **

```js name=fixStaleClosure line={10}
function App() {
  let count = 0;

  function increment() {
    count = count + 1;
    console.log(count);
  }

  function log() {
    const message = `Count is ${count}`;
    console.log(message);
  }

  return [increment, log];
}

const [increment, log] = App();
increment();
increment();
log();
```

```shell name=output
1
2
Count is 2
```

æŠŠ message æ”¾åœ¨`log`é‡Œé¢ï¼Œè¿™æ ·è°ƒç”¨`log`æ—¶å°±ä¼šé‡æ–°ç”Ÿæˆ`message`ã€‚

### å¦ä¸€ä¸ªè¿‡æ—¶é—­åŒ…çš„ä¾‹å­

```js name=staleClosure2
let count = 0;

const increment = () => {
  count += 1;
  const message = `Count is ${count}`;

  return () => {
    console.log(message);
    console.log(count);
  };
};

const log = increment();
increment();
log();
```

```shell name=output
Count is 1
2
```

å‡½æ•°`log`çš„æ‰§è¡Œç»“æœä¾ç„¶æ²¡æœ‰æ‹¿åˆ°æœ€æ–°çš„`message`å€¼ã€‚

ğŸ” åˆ†æä¸Šé¢çš„ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼š

1. å£°æ˜å…¨å±€å˜é‡ `count`ï¼Œå­˜å…¥å€¼`0`
2. æ‰§è¡Œ `increment`
3. ä¿®æ”¹å…¨å±€å˜é‡`count`ä¸º`1`
4. å£°æ˜å±€éƒ¨å˜é‡`message`, å­˜å…¥å€¼ `Count is 1`
5. è¿”å›åŒ¿åå‡½æ•°
6. å£°æ˜å…¨å±€å¸¸é‡ `log` å¹¶å‚¨å­˜ä¸Šæ­¥è¿”å›çš„åŒ¿åå‡½æ•°ã€‚`increment`æ‰§è¡Œå®Œæ¯•å‡ºæ ˆã€‚`log`å¼•ç”¨å¹¶æ•è·`message`ï¼Œ`message`å¾—ä»¥ä¸è¢« GC å›æ”¶
7. å†æ¬¡æ‰§è¡Œ`increment`, ä¿®æ”¹å…¨å±€å˜é‡`count`ä¸º`2`ï¼Œæ–°å£°æ˜å±€éƒ¨å˜é‡`message`ï¼Œåˆ†é…å†…å­˜ï¼Œå­˜å…¥å€¼ `Count is 2`, è¿™ä¸ª`message`å’Œä¸Šä¸€æ­¥çš„`message`åœ¨ä¸åŒçš„æ‰§è¡Œä¸Šä¸‹æ–‡ï¼Œåˆ†é…åœ¨ä¸åŒçš„å†…å­˜åœ°å€ï¼Œå°†å…¶å‡è®¾ä¸º`message2`
8. è¿”å›åŒ¿åå‡½æ•°ï¼Œä½†å¹¶æ²¡æœ‰å£°æ˜å˜é‡å­˜ä¸‹æ¥ï¼Œå…¶å¼•ç”¨çš„å±€éƒ¨å˜é‡`message2`ä¹Ÿè¢« GC å›æ”¶
9. æ‰§è¡Œç¬¬å…­æ­¥çš„`log`å‡½æ•°ï¼Œæ‰“å° `message`çš„å€¼ï¼Œè¯¥`message`ä¸º`message1`ï¼Œå³ `Count is 1`

![closure2](./closure2.png)

`log`æ‰“å°å‡º count æ—§å€¼çš„åŸå› æ˜¯é—­åŒ…å‡½æ•°å¼•ç”¨çš„æ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œ`increment`æ—¶çš„è¯æ³•ç¯å¢ƒï¼Œå…¶`message`æ˜¯ç¬¬ä¸€æ¬¡æ‰§è¡Œ`increment`æ—¶çš„å€¼ã€‚å’Œä¸Šé¢çš„å¤ç°é—­åŒ…ç¬¬ä¸€ä¸ªä¾‹å­ä¸€æ¨¡ä¸€æ ·ã€‚

**ä¿®æ­£è¿‡åçš„ä»£ç **

```js name=fixStaleClosure2 line={7}
let count = 0;

const increment = () => {
  count += 1;

  return () => {
    const message = `Count is ${count}`;
    console.log(message);
    console.log(count);
  };
};

const log = increment();
increment();
log();
```

åŒæ ·åœ°ï¼Œå°†`message`çš„å£°æ˜å’Œèµ‹å€¼æ”¾åˆ°äº†åŒ¿åå‡½æ•°å†…ã€‚

## hooks å’Œé—­åŒ…çš„å…³ç³»

> å‚è€ƒæ–‡ç« ï¼š[è¶…æ€§æ„Ÿçš„ React Hooksï¼ˆäºŒï¼‰å†è°ˆé—­åŒ…](https://mp.weixin.qq.com/s/IMgHzeDXIbxMsVomnqx7AQ)

ç¬¬äºŒæ­¥ï¼Œææ‡‚æ—¥å¸¸ç”¨çš„ hook å’Œé—­åŒ…çš„å…³ç³»ã€‚

ç®€åŒ–ç‰ˆçš„ useStateï¼Œå®é™…çš„ hook å®ç°è‚¯å®šæ¯”è¿™å¤æ‚ï¼Œä½†æ˜¯åŸç†éƒ½å·®ä¸å¤šã€‚

```jsx name=state
let state = null;

export const useState = (value: number) => {
  state = state || value;

  function dispatch(newValue) {
    state = newValue;
    // å‡è®¾æ­¤æ–¹æ³•èƒ½è§¦å‘é¡µé¢æ¸²æŸ“
    render();
  }

  return [state, dispatch];
};
```

åœ¨å…¶ä»–æ¨¡å—ä¸­å¼•ç”¨

```jsx name=Demo.jsx
import React from 'react';
import { useState } from './state';

export function Demo() {
  const [counter, setCounter] = useState(0);

  return (
    <div onClick={() => setCounter(counter + 1)}>hello world, {counter}</div>
  );
}
```

### é—­åŒ…åœ¨å“ªï¼Ÿ

**ES Module çš„åŸç†**

1. ES6 ä¹‹å‰: ES6 ä¹‹å‰æ‹†åˆ†æ¨¡å—å’Œé˜²æ­¢å˜é‡æ±¡æŸ“ä¸»è¦é è‡ªæ‰§è¡Œå‡½æ•°ï¼ŒAMD/CMD è§„èŒƒéƒ½æ˜¯åŸºäºå‡½æ•°ã€‚webpack æ‰“åŒ… ES6 åˆ° ES5 ä¹Ÿä¼šè‡ªåŠ¨æŠŠä»£ç é‡Œçš„ ES module è¯­æ³•æ‰“åŒ…æˆå‡½æ•°å’Œè‡ªæ‰§è¡Œå‡½æ•°ã€‚

```js name=è‡ªæ‰§è¡Œå‡½æ•°ç‰ˆstate
(function () {
  var state = null;

  var useState = function (value) {
    state = state || value;

    function dispatch(newValue) {
      state = newValue;
      render();
    }

    return [state, dispatch];
  };

  return { useState };
})();
```

2. ES6 ä¹‹å: å‚è€ƒ[ES modules: A cartoon deep-dive](https://hacks.mozilla.org/2018/03/es-modules-a-cartoon-deep-dive/), [æ˜é‡‘ç¿»è¯‘ç‰ˆ](https://juejin.cn/post/7098192216229117959)ã€‚

ES module è™½ç„¶åŸç†å’Œè‡ªæ‰§è¡Œå‡½æ•°ä¸åŒï¼Œä½†è¡¨ç°å½¢å¼ååˆ†ç›¸ä¼¼ã€‚

è¢«`useState`å¼•ç”¨çš„`state`å˜é‡åˆ™ä¼šå­˜åœ¨äºå†…å­˜ä¸­ï¼Œåªè¦è¯¥å˜é‡è¿˜è¢«æ ‡è®°ä¸ºå¼•ç”¨çŠ¶æ€ï¼Œå°±ä¸ä¼šè¢« GC å›æ”¶ã€‚

åœ¨ Demo module å†…é€šè¿‡ `useState` å¼•ç”¨ state module (å¤–éƒ¨è¯æ³•ç¯å¢ƒ)é‡Œçš„å˜é‡ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ ‡å‡†çš„é—­åŒ…ã€‚

### å†çœ‹ useEffect

```jsx name=å®šæ—¶å™¨ live noInline
// ä½ å¯ä»¥å°†ä¸¤ä¸ª debuggerå–æ¶ˆæ³¨é‡Šï¼Œæ‰“å¼€æ§åˆ¶å°ï¼Œå¯ä»¥ç›´è§‚åœ°çœ‹åˆ°ä¸¤å¤„debuggeræ‰€å¤„çš„ä½œç”¨åŸŸ
const { useMyState } = (function () {
  let state = null;

  const useMyState = function (value) {
    state = state || value;

    function dispatch(newValue) {
      state = newValue;
      // debugger;
    }

    return [state, dispatch];
  };
  return { useMyState };
})();

function Timer() {
  // è¿™æ˜¯ä¸ªå‡çš„stateï¼Œä¸ä¼šè§¦å‘renderï¼Œæ‰€ä»¥ä½ ä¼šçœ‹åˆ°è®¡æ•°å§‹ç»ˆä¸º0
  const [count, setCount] = useMyState(0);

  useEffect(() => {
    const handleCount = () => {
      // debugger;
      setCount(count + 1);
    };

    setInterval(handleCount, 500);
  }, []);

  return (
    <div>
      <p>Count: {count}</p>
    </div>
  );
}
render(<Timer />);
```

`useEffect`çš„ç¬¬äºŒä¸ªå‚æ•°å¦‚æœæ˜¯`[]`ï¼Œé‚£ä¹ˆè¯¥å‰¯ä½œç”¨åªä¼šåœ¨å‡½æ•°ç»„å»º mounted æ—¶æ‰§è¡Œä¸€æ¬¡ã€‚

ğŸ” åˆ†æé¦–æ¬¡`useEffect`çš„ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹ï¼š

1. ç»„ä»¶ mounted, è§¦å‘`useEffect`ï¼Œæ‰§è¡Œä¼ å…¥çš„åŒ¿åå›è°ƒå‡½æ•°
2. å£°æ˜å‡½æ•°`handleCount`
3. `handleCount`å†…å¼•ç”¨äº†å¤–éƒ¨è¯æ³•ç¯å¢ƒ`Timer`ä¸­çš„å˜é‡ `count`ï¼Œå½¢æˆäº†é—­åŒ…ï¼Œ`[[Scopes]]`å†…æ–°å¢`Closure(Timer)`ã€‚
   ![hookClosure1](./hook-closure1.png)
4. å‡½æ•°ç»„ä»¶ `Timer`æ‰§è¡Œå®Œæ¯•ï¼Œå‡ºæ ˆé”€æ¯ã€‚å˜é‡`count`å› ä¸ºè¢«`handleCount`å¼•ç”¨å¾—ä»¥ä¿ç•™ã€‚
5. 500ms åæ‰§è¡Œ`handleCount`ï¼Œè°ƒç”¨`dispatch`ä¿®æ”¹ `state` çš„å€¼
   ![hookClosure2](./hook-closure2.png)
   å¯ä»¥çœ‹åˆ°`dispatch`çš„é—­åŒ…å†…ï¼Œ`state` å·²ç»å˜æˆäº† 1

ä½ å¯èƒ½ä¼šç–‘æƒ‘ï¼ŒæŒ‰ç…§å‰é¢çš„ç»“è®ºï¼Œæ­¤æ—¶é—­åŒ…å‡½æ•°`handleCount`å’Œ`dispatch`åº”è¯¥å¼•ç”¨çš„åŒä¸€ä¸ªè¯æ³•ç¯å¢ƒæ‰å¯¹ã€‚å®é™…ä¸Šå‘¢ï¼Ÿ

æœ€ç®€å•çš„ï¼Œçœ‹ä¸Šé¢ä¸¤ä¸ªæˆªå›¾ï¼Œåœ¨ scope çš„`Closure`é‚£é‡Œï¼Œä¸€ä¸ªæ˜¯`Closure(Timer)`ä¸€ä¸ªæ˜¯`Closure`

`handleCount` ä¸­å¼•ç”¨çš„`count`, æ˜¯åœ¨`Timer`æ‰§è¡Œç”Ÿæˆçš„:`const count = useMyState(0)[0]` ä¹Ÿå°±æ˜¯ `count: 0`, å’Œç¬¬ä¸€ä¸ªè¿‡æ—¶é—­åŒ…çš„ä¾‹å­ä¸€æ¨¡ä¸€æ ·`let message = "count is " + count`

`useEffect`, `useMemo`, `useCallback` ç­‰ memorization hooks éƒ½ä¼šé¢ä¸´ç›¸åŒçš„è¿‡æ—¶é—­åŒ…é—®é¢˜ï¼Œè€Œä¸”è¿™ç±»å‹ bug å¾ˆéš¾å‘ç°ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæœ€æ–°çš„ react æ–‡æ¡£å»ºè®®å¼€å‘è€…æœ€å¥½å¼€å¯ deps eslintï¼Œä»¥åŠæœ€å¥½ä¸è¦ ban æ‰ eslint ä»¥ [æ¬ºéª— react](https://react.dev/reference/react/useEffect#specifying-reactive-dependencies)

ç»“åˆ memorization hooks (åé¢éƒ½ä»¥`useEffect`ä¸ºä¾‹)çš„ç‰¹æ€§ï¼Œå¤ç›˜ä¸€ä¸‹ï¼š

åœ¨ `useEffect` çš„å›è°ƒå‡½æ•°ä¸­å¼•ç”¨äº†å¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡ï¼Œä½†æ˜¯æ²¡æœ‰å°†è¯¥å˜é‡æ·»åŠ è¿› `useEffect` çš„ deps æ•°ç»„å†…ã€‚åªæœ‰åœ¨ deps `useEffect` ä¸­çš„å›è°ƒå‡½æ•°æ‰ä¼šé‡æ–°æ‰§è¡Œã€‚
ç”±äºæˆ‘ä»¬å°‘ä¼ æˆ–æ²¡æœ‰ä¼ ç›¸åº”çš„ depsï¼Œå½“æ¼ç½‘ä¹‹é±¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œ`useEffect` å¹¶æ²¡æœ‰è§¦å‘ï¼Œ`useEffect` å†…çš„é—­åŒ…å‡½æ•°æ‰€æ•è·çš„è¿˜æ˜¯ä¸Šä¸€æ¬¡ `useEffect` æ‰§è¡Œæ—¶çš„è¯æ³•ç¯å¢ƒä¸­çš„å˜é‡ï¼Œå°±äº§ç”Ÿäº†è¿‡æ—¶é—­åŒ…çš„ bugã€‚

## ä¸æŒ‡å®šä¾èµ–å°±ä¸€å®šä¼šå‡ºç° bug å—ï¼Ÿ

ä»å‰ä¸€ç« èŠ‚æˆ‘ä»¬çŸ¥é“äº†é—­åŒ…é™·é˜±çš„åŸå› ã€‚ä½†å®é™…é¡¹ç›®é‡Œæˆ‘ä»¬ç»å¤§éƒ¨åˆ†äººéƒ½å†™è¿‡ä¸‹é¢è¿™å¥ eslint-disable

```js ä¸è¦ä½ è§‰å¾—ï¼Œæˆ‘è¦æˆ‘è§‰å¾—
// eslint-disable-next-line react-hooks/exhaustive-deps
```

é¡¹ç›®å¹¶ä¸ä¼šå‡º bugï¼Œä¸ºä»€ä¹ˆï¼Ÿ

å› ä¸ºä»ä¸Šé¢ä¸¾çš„å¾ˆå¤šä¾‹å­ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå‡ºè¿‡æ—¶é—­åŒ…çš„ bug éœ€è¦æ»¡è¶³å‡ ä¸ªæ¡ä»¶ï¼š

1. è¿™ä¸ªè¢«å¿½ç•¥æ‰çš„ dep æœ¬èº«æ˜¯å¯å˜çš„ã€‚
2. æˆ‘ä»¬è¦åœ¨äº‹ä»¶ç»‘å®šæˆ–è€…å®šæ—¶å™¨ä¸­ç”¨åˆ°è¿™ä¸ªå¯å˜çš„æ•°æ®

å¦å¤–ï¼Œ`useEffect` çš„ç‰¹æ€§æ˜¯åªè¦ deps æ•°ç»„ä¸­æœ‰ä¸€é¡¹æ•°æ®å‘ç”Ÿäº†å˜åŒ–ï¼Œå°±ä¼šæ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œå¦‚æœæœ‰ä¸€ä¸ªå˜é‡`b`å’Œè¢«å¿½ç•¥çš„å˜é‡`a`æ€»æ˜¯åŒæ—¶æ›´æ–°(æ¯”å¦‚ä»–ä¿©æ¥è‡ªäºåŒä¸€ä¸ªæ¥å£æ•°æ®)ï¼Œé‚£ä¹ˆå“ªæ€• deps æ•°ç»„é‡Œåªæœ‰å˜é‡`b`ï¼Œ`useEffect` çš„æ¯æ¬¡è§¦å‘ï¼Œé—­åŒ…å‡½æ•°éƒ½èƒ½ç»‘å®šæœ€æ–°çš„`a`

`useEffect`æœ€å¤§çš„å¿ƒæ™ºè´Ÿæ‹…å°±åœ¨è¿™é‡Œï¼šeslint å¼ºè¿«æˆ‘ä»¬å°†`useEffect`ä¸­æ‰€æœ‰ç”¨åˆ°çš„ propï¼Œstate å…¨éƒ¨æ”¾åˆ° deps æ•°ç»„ä¸­ï¼Œå³å°†è¯¥æ•°ç»„å½“æˆäº†é—­åŒ…ä¼šå¼•ç”¨çš„å˜é‡çš„å…¨å®¶ç¦ã€‚

ä½† `useEffect`æœ¬èº«çš„ä½œç”¨æ˜¯å“åº”çŠ¶æ€å˜æ›´çš„å‰¯ä½œç”¨ï¼Œç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹æˆ‘ä»¬ä¸æƒ³å¯¹æ‰€æœ‰çš„ä¾èµ–è¿›è¡Œå“åº”ï¼Œæˆ‘ä»¬åªæƒ³è¦èƒ½é€šè¿‡æŸä¸ªçŠ¶æ€èƒ½ trigger effectï¼Œç„¶åè¯¥ Effect èƒ½æ‹¿åˆ°æœ€æ–°çš„ä¾èµ–ï¼Œæ‰§è¡Œæˆ‘ä»¬æƒ³è¦çš„æ“ä½œã€‚

æˆ‘ä»¬æƒ³è¦ deps æ•°ç»„æœ‰ä¸šåŠ¡å«ä¹‰ï¼Œè€Œä¸æ˜¯é•¿ç ´å¤©çš„å…¨å®¶ç¦ã€‚æˆ‘ä»¬æƒ³è¦ deps æ•°ç»„é‡Œä¸ç”¨å†ä¼ å…¥æ¯«æ— æ„ä¹‰çš„ handle æˆ– dispatch å‡½æ•°ã€‚

ç›®å‰æˆ‘ä»¬åªèƒ½åœ¨ç†Ÿæ‚‰ä¸Šä¸‹æ–‡çš„æƒ…å†µä¸‹ï¼Œæ‰‹åŠ¨æ·»åŠ  eslint-disableğŸ˜…

ä½†ç›®å‰çš„ React å¹¶ä¸æ¬¢è¿æˆ‘ä»¬è¿™ä¹ˆåšã€‚å…¶ç†ç”±æ˜¯å³ä¾¿ å¼€å‘ Dev åœ¨äº†è§£ä¸Šä¸‹æ–‡å¹¶ä¿è¯æ²¡æœ‰ bug çš„æƒ…å†µä¸‹ ban æ‰äº† eslintï¼Œä»–ä¾ç„¶æ— æ³•é¢„çŸ¥ä»£ç çš„åç»­ç»´æŠ¤è€…æ˜¯å¦æ¸…æ¥šä¸Šä¸‹æ–‡ã€‚è¿™å¾ˆå®¹æ˜“ç»™åç»­çš„ç»´æŠ¤ç•™ä¸‹éšæ‚£ã€‚

## è§£å†³é—­åŒ…é™·é˜±çš„æ—§æ–¹æ¡ˆ

é™¤äº†å†™å…¨ depsï¼Œè¿˜æœ‰ä¸€äº›æ–¹æ¡ˆå¯ä»¥ç”¨

### useState å›è°ƒå‡½æ•°

```jsx live name=å®šæ—¶å™¨
function Timer() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const handleCount = () => {
      setCount((count) => count + 1);
    };
    setInterval(handleCount, 500);
  }, []);

  return (
    <div>
      <p>Count: {count}</p>
    </div>
  );
}
```

### ref

```jsx live name=å®šæ—¶å™¨
function Timer() {
  const [count, setCount] = useState(0);
  const countRef = useRef(count);

  useEffect(() => {
    const handleCount = () => {
      countRef.current += 1;
      setCount(countRef.current);
    };
    setInterval(handleCount, 500);
  }, []);

  return (
    <div>
      <p>Count: {count}</p>
    </div>
  );
}
```

ref çš„åŸç†ä¾æ—§æ˜¯é—­åŒ…ï¼Œæ¯æ¬¡`Timer`æ‰§è¡Œï¼Œ`useRef`éƒ½ä¼šè¿”å›åŒä¸€ä¸ªå›ºå®šçš„å¯¹è±¡å¼•ç”¨ã€‚æˆ‘ä»¬å¯ä»¥åœ¨é—­åŒ…å†…é€šè¿‡è®¿é—®å¯¹è±¡çš„ current å±æ€§æ‹¿åˆ°æœ€æ–°çš„`count`å€¼
![ref é—­åŒ…](./ref-closure.png)

ref çš„åŠæ³•æ¯”è¾ƒé€‚åˆç”¨æ¥å¤„ç†ä¸€äº›ä¾èµ–è¾ƒå¤šçš„å‡½æ•°ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼Œ
æˆ‘åªæƒ³ useEffect åœ¨ mounted çš„æ—¶å€™è§¦å‘ä¸€æ¬¡ï¼š

```jsx name=functionDemo line={10}
const Demo = ({ name, height, weight, onError, onOk, path }) => {
  const complexFunction = () => {
    console.log(name, height, weight, path);
    onError();
    onOk();
  };

  useEffect(() => {
    complexFunction();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);
};
```

ç”¨ ref å°±ä¸ç”¨ ban eslintï¼Œä¹Ÿä¸ä¼šå‡ºç°è¿‡æ—¶é—­åŒ…ã€‚

```jsx name=refDemo
const Demo = ({ name, height, weight, onError, onOk, path }) => {
  const complexFunctionRef = useRef(() => {
    console.log(name, height, weight, path);
    onError();
    onOk();
  });
  useEffect(() => {
    complexFunctionRef.current();
  }, []);
};
```

## æ–°çš„ hook - useEffectEvent

[Declaring an Effect Event](https://react.dev/learn/separating-events-from-effects#declaring-an-effect-event)

`useEffectEvent` çš„å†…éƒ¨å®ç°å°±æ˜¯åŸºäº refï¼Œå…¶ä½œç”¨å°±æ˜¯å‡å°‘ memorization hooks ä¸å¿…è¦çš„ depsã€‚

```jsx name=useEffectEventDemo
const Demo = ({ name, height, weight, onError, onOk, path }) => {
  const complexEvent = useEffectEvent(() => {
    console.log(name, height, weight, path);
    onError();
    onOk();
  });

  useEffect(() => {
    complexEvent();
  }, []);
};
```

æœ‰äº†è¿™ä¸ª hook ä¹‹åï¼Œ`useEffect`çš„ deps å°±å¯ä»¥åªä¿ç•™ä¸šåŠ¡ä¸Šç”¨äºè§¦å‘ effet çš„çŠ¶æ€ï¼Œå…¶ä»–çš„éƒ½ä¸¢ç»™`useEventEffect`
