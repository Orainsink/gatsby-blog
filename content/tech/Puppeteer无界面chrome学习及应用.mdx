---
title: Puppeteeræ— ç•Œé¢chromeå­¦ä¹ åŠåº”ç”¨åœºæ™¯åˆ†æ
date: 2020-12-30 17:01:41
description:
tags: [æ€§èƒ½, nodejs]
categories: tech
---

> Puppeteer å¯ä»¥æ¨¡æ‹ŸChromeæµè§ˆå™¨çš„è¿è¡Œï¼Œè®©æˆ‘ä»¬å¯ä»¥åœ¨æœåŠ¡å™¨ç¯å¢ƒè°ƒç”¨æµè§ˆå™¨æä¾›çš„æ–¹æ³•ã€‚

å› ä¸ºæˆ‘ä¹Ÿæ˜¯ä»å¤´å¼€å§‹å­¦ä¹ ï¼Œæ‰€ä»¥æœ¬æ–‡å¤§é‡å‚è€ƒçŸ¥ä¹çš„åˆ†äº«[ç»“åˆé¡¹ç›®æ¥è°ˆè°ˆ Puppeteer - çŸ¥ä¹ (zhihu.com)](https://zhuanlan.zhihu.com/p/76237595)ï¼Œå¹¶ä¸”ç»“åˆè‡ªå·±çš„é¡¹ç›®åˆ†æä¸€ä¸‹åº”ç”¨åœºæ™¯ã€‚

## [ä»€ä¹ˆæ˜¯ Chrome DevTool Protocol](https://chromedevtools.github.io/devtools-protocol/)

- CDP åŸºäº WebSocketï¼Œåˆ©ç”¨ WebSocket å®ç°ä¸æµè§ˆå™¨å†…æ ¸çš„å¿«é€Ÿæ•°æ®é€šé“
- CDP åˆ†ä¸ºå¤šä¸ªåŸŸï¼ˆDOMï¼ŒDebuggerï¼ŒNetworkï¼ŒProfilerï¼ŒConsole...ï¼‰ï¼Œæ¯ä¸ªåŸŸä¸­éƒ½å®šä¹‰äº†ç›¸å…³çš„å‘½ä»¤å’Œäº‹ä»¶ï¼ˆCommands and Eventsï¼‰
- æˆ‘ä»¬å¯ä»¥åŸºäº CDP å°è£…ä¸€äº›å·¥å…·å¯¹ Chrome æµè§ˆå™¨è¿›è¡Œè°ƒè¯•åŠåˆ†æï¼Œæ¯”å¦‚æˆ‘ä»¬å¸¸ç”¨çš„ â€œChrome å¼€å‘è€…å·¥å…·â€ å°±æ˜¯åŸºäº CDP å®ç°çš„
- å¦‚æœä½ ä»¥ `remote-debugging-port` å‚æ•°å¯åŠ¨ Chromeï¼Œé‚£ä¹ˆå°±å¯ä»¥çœ‹åˆ°æ‰€æœ‰ Tab é¡µé¢çš„å¼€å‘è€…è°ƒè¯•å‰ç«¯é¡µé¢ï¼Œè¿˜ä¼šåœ¨åŒä¸€ç«¯å£ä¸Šè¿˜æä¾›äº† http æœåŠ¡ï¼Œä¸»è¦æä¾›ä»¥ä¸‹å‡ ä¸ªæ¥å£ï¼š

```shell
GET /json/version                     # è·å–æµè§ˆå™¨çš„ä¸€äº›å…ƒä¿¡æ¯
GET /json or /json/list               # å½“å‰æµè§ˆå™¨ä¸Šæ‰“å¼€çš„ä¸€äº›é¡µé¢ä¿¡æ¯
GET /json/protocol                    # è·å–å½“å‰ CDP çš„åè®®ä¿¡æ¯   
GET /json/new?{url}                   # å¼€å¯ä¸€å…±æ–°çš„ Tab é¡µé¢
GET /json/activate/{targetId}         # æ¿€æ´»æŸä¸ªé¡µé¢æˆä¸ºå½“å‰æ˜¾ç¤ºçš„é¡µé¢
GET /json/close/{targetId}            # å…³é—­æŸä¸ªé¡µé¢
GET /devtools/inspector.html          # æ‰“å¼€å½“å‰é¡µé¢çš„å¼€å‘è€…è°ƒè¯•å·¥å…·
WebSocket /devtools/page/{targetId}   # è·å–æŸä¸ªé¡µé¢çš„ websocket åœ°å€
```

- å¾ˆå¤šæœ‰ç”¨çš„å·¥å…·éƒ½æ˜¯åŸºäº CDP å®ç°çš„ï¼Œæ¯”å¦‚ [Chrome å¼€å‘è€…å·¥å…·](https://developers.google.cn/web/tools/chrome-devtools/)ï¼Œ[chrome-remote-interface](https://github.com/cyrus-and/chrome-remote-interface)ï¼Œ[Puppeteer](https://github.com/GoogleChrome/puppeteer/) ç­‰

## ä»€ä¹ˆæ˜¯ Headless Chrome

- åœ¨æ— ç•Œé¢çš„ç¯å¢ƒä¸­è¿è¡Œ Chrome
- é€šè¿‡å‘½ä»¤è¡Œæˆ–è€…ç¨‹åºè¯­è¨€æ“ä½œ Chrome
- æ— éœ€äººçš„å¹²é¢„ï¼Œè¿è¡Œæ›´ç¨³å®š
- åœ¨å¯åŠ¨ Chrome æ—¶æ·»åŠ å‚æ•° `--headless`ï¼Œä¾¿å¯ä»¥ headless æ¨¡å¼å¯åŠ¨ Chrome

```shell
alias chrome="/Applications/Google\ Chrome.app/Contents/MacOS/Google\ Chrome"  # Mac OS X å‘½ä»¤åˆ«å
chrome --headless --remote-debugging-port=9222 --disable-gpu                   # å¼€å¯è¿œç¨‹è°ƒè¯•
chrome --headless --disable-gpu --dump-dom https://www.baidu.com               # è·å–é¡µé¢ DOM
chrome --headless --disable-gpu --screenshot https://www.baidu.com             # æˆªå›¾
```

- chrome å¯åŠ¨æ—¶å¯ä»¥åŠ ä¸€äº›ä»€ä¹ˆå‚æ•°ï¼Œå¤§å®¶å¯ä»¥ç‚¹å‡»[è¿™é‡Œ](https://peter.sh/experiments/chromium-command-line-switches/)æŸ¥çœ‹

## Puppeteer æ˜¯ä»€ä¹ˆ

- Puppeteer æ˜¯ Node.js å·¥å…·å¼•æ“
- Puppeteer æä¾›äº†ä¸€ç³»åˆ— APIï¼Œé€šè¿‡ Chrome DevTools Protocol åè®®æ§åˆ¶ Chromium/Chrome æµè§ˆå™¨çš„è¡Œä¸º
- Puppeteer é»˜è®¤æƒ…å†µä¸‹æ˜¯ä»¥ headless å¯åŠ¨ Chrome çš„ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‚æ•°æ§åˆ¶å¯åŠ¨æœ‰ç•Œé¢çš„ Chrome
- Puppeteer é»˜è®¤ç»‘å®šæœ€æ–°çš„ Chromium ç‰ˆæœ¬ï¼Œä¹Ÿå¯ä»¥è‡ªå·±è®¾ç½®ä¸åŒç‰ˆæœ¬çš„ç»‘å®š
- Puppeteer è®©æˆ‘ä»¬ä¸éœ€è¦äº†è§£å¤ªå¤šçš„åº•å±‚ CDP åè®®å®ç°ä¸æµè§ˆå™¨çš„é€šä¿¡

## Puppeteer èƒ½åšä»€ä¹ˆ

å®˜æ–¹ç§°ï¼šâ€œMost things that you can do manually in the browser can be done using Puppeteerâ€ï¼Œé‚£ä¹ˆå…·ä½“å¯ä»¥åšäº›ä»€ä¹ˆå‘¢ï¼Ÿ

- ç½‘é¡µæˆªå›¾æˆ–è€…ç”Ÿæˆ PDF
- çˆ¬å– SPA æˆ– SSR ç½‘ç«™
- UI è‡ªåŠ¨åŒ–æµ‹è¯•ï¼Œæ¨¡æ‹Ÿè¡¨å•æäº¤ï¼Œé”®ç›˜è¾“å…¥ï¼Œç‚¹å‡»ç­‰è¡Œä¸º
- æ•è·ç½‘ç«™çš„æ—¶é—´çº¿ï¼Œå¸®åŠ©è¯Šæ–­æ€§èƒ½é—®é¢˜
- åˆ›å»ºä¸€ä¸ªæœ€æ–°çš„è‡ªåŠ¨åŒ–æµ‹è¯•ç¯å¢ƒï¼Œä½¿ç”¨æœ€æ–°çš„ js å’Œæœ€æ–°çš„ Chrome æµè§ˆå™¨è¿è¡Œæµ‹è¯•ç”¨ä¾‹
- æµ‹è¯• Chrome æ‰©å±•ç¨‹åº
- ...

## MORE

ä½¿ç”¨åŠæ³•è¿™ä¸€éƒ¨åˆ†ç”±äºåŸæ–‡å·²ç»å†™çš„éå¸¸å¥½äº†ï¼Œä¸ºäº†ä¸å½±å“åˆ«äººçš„æµé‡è¿˜æ˜¯ä¸æ¬å®Œäº†ã€‚ä»¥ä¸‹é‡ç‚¹è¯´ä¸€ä¸‹æˆ‘ä»¬æƒ³ç”¨è¿™ä¸ªå·¥å…·å®ç°çš„ä¸€äº›åŠŸèƒ½å’Œä»–èƒ½è§£å†³çš„ç—›ç‚¹ã€‚

## ğŸ‘´æˆ‘ä»¬æƒ³ç”¨Puppeteerå®ç°çš„åŠŸèƒ½

Puppeteerå¯ä»¥è§£å†³æˆ‘ä»¬å‰ç«¯çš„ä¸€å¤§ç—›ç‚¹ï¼Œå°±æ˜¯å¯¼å‡ºå›¾ç‰‡æ—¶çš„æ€§èƒ½é—®é¢˜ã€‚

ç”±äºæˆ‘ä»¬åšçš„æ˜¯æ•°æ®äº§å“ï¼Œè€Œä¸”UIè®¾è®¡ç»„çš„çµæ„Ÿæ€»æ˜¯å¤©é©¬è¡Œç©ºï¼Œä¸æŒ‰å¸¸ç†å‡ºç‰Œï¼Œå¯¼è‡´æˆ‘ä»¬çš„é¡µé¢ç›¸å½“å¤æ‚æ€»æ˜¯å ç”¨å¾ˆå¤§çš„å†…å­˜ï¼ŒåŒæ—¶ç»å¸¸ä¼šæœ‰å„ç§å›¾è¡¨å’Œå¥‡è‘©UIï¼Œè¿™æ—¶å€™å¦‚æœæƒ³ç”¨ [html2canvas](https://www.npmjs.com/package/html2canvas) è¿™ä¸ªå·¥å…·æ¥å®ç°å‰ç«¯å¯¼å‡ºå°±ä¼šé‡åˆ°å„ç§ç¨€å¥‡å¤æ€ªçš„é—®é¢˜ã€‚

å…¶ä¸­æœ€å¤§çš„é—®é¢˜å°±æ˜¯htmlè½¬åŒ–ä¸ºå›¾ç‰‡çš„æ—¶å€™ä¼šæœ‰ç›¸å½“ç¨‹åº¦çš„å¡é¡¿ï¼Œè€Œä¸”å­˜åœ¨å›¾è¡¨è¿˜æ²¡ç»˜åˆ¶å®Œæˆçš„æ—¶å€™ï¼Œcanvaså›¾ç‰‡å…ˆå¯¼å‡ºäº†çš„æƒ…å†µï¼Œå¯¼è‡´å¯¼å‡ºçš„å›¾ç‰‡æ²¡æœ‰å›¾è¡¨ï¼Œç›®å‰çš„å¤„ç†åŠæ³•æ˜¯è®¾ç½®äº†ä¸€ä¸ªè¾ƒçŸ­æ—¶é—´çš„å»¶æ—¶ï¼Œä½†æ˜¯è¿™ç§è§£å†³åŠæ³•å¾ˆlowï¼Œè€Œä¸”å®é™…ä¸Šå¹¶æ²¡æœ‰è§£å†³é—®é¢˜ã€‚

### ç”¨Puppeteerå¯¼å‡ºå›¾ç‰‡

å•ç‹¬è·‘ä¸€ä¸ªPuppeteeræœåŠ¡ï¼Œå½“æˆ‘ä»¬ç‚¹å‡»ç½‘ç«™ä¸Šçš„å¯¼å‡ºå›¾ç‰‡æŒ‰é’®çš„æ—¶å€™ï¼Œæºå¸¦å‚æ•°å‘é€è¯·æ±‚ç»™åç«¯ï¼Œåç«¯é€šè¿‡Puppeteerç›´æ¥ä»Headless Chromeé‡Œè®¿é—®ä¸“é—¨ç”¨æ¥å¯¼å‡ºçš„é¡µé¢æˆªå–ç½‘é¡µå…ƒç´ ï¼Œç„¶åå‘ç»™ç”¨æˆ·çš„æµè§ˆå™¨ï¼Œè¿™æ ·å¯ä»¥é¿å…æµè§ˆå™¨è‡ªå·±ç”Ÿæˆå›¾ç‰‡å¸¦æ¥çš„æ€§èƒ½é—®é¢˜å’Œä¸€äº›cssæ ·å¼ä¸æ”¯æŒçš„é—®é¢˜ã€‚

æˆ‘ä»¬ä½¿ç”¨ Puppeteer æ—¢å¯ä»¥å¯¹æŸä¸ªé¡µé¢è¿›è¡Œæˆªå›¾ï¼Œä¹Ÿå¯ä»¥å¯¹é¡µé¢ä¸­çš„æŸä¸ªå…ƒç´ è¿›è¡Œæˆªå›¾ï¼š

```js
(async () => {
    const browser = await puppeteer.launch();
    const page = await browser.newPage();
    //è®¾ç½®å¯è§†åŒºåŸŸå¤§å°
    await page.setViewport({width: 1920, height: 800});
    await page.goto('https://youdata.163.com');
    //å¯¹æ•´ä¸ªé¡µé¢æˆªå›¾
    await page.screenshot({
        path: './files/capture.png',  //å›¾ç‰‡ä¿å­˜è·¯å¾„
        type: 'png',
        fullPage: true //è¾¹æ»šåŠ¨è¾¹æˆªå›¾
        // clip: {x: 0, y: 0, width: 1920, height: 800}
    });
    //å¯¹é¡µé¢æŸä¸ªå…ƒç´ æˆªå›¾
    let [element] = await page.$x('/html/body/section[4]/div/div[2]');
    await element.screenshot({
        path: './files/element.png'
    });
    await page.close();
    await browser.close();
})();
```

æˆ‘ä»¬æ€ä¹ˆå»è·å–é¡µé¢ä¸­çš„æŸä¸ªå…ƒç´ å‘¢ï¼Ÿ

- `page.$('#uniqueId')`ï¼šè·å–æŸä¸ªé€‰æ‹©å™¨å¯¹åº”çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
- `page.$$('div')`ï¼šè·å–æŸä¸ªé€‰æ‹©å™¨å¯¹åº”çš„æ‰€æœ‰å…ƒç´ 
- `page.$x('//img')`ï¼šè·å–æŸä¸ª xPath å¯¹åº”çš„æ‰€æœ‰å…ƒç´ 
- `page.waitForXPath('//img')`ï¼šç­‰å¾…æŸä¸ª xPath å¯¹åº”çš„å…ƒç´ å‡ºç°
- `page.waitForSelector('#uniqueId')`ï¼šç­‰å¾…æŸä¸ªé€‰æ‹©å™¨å¯¹åº”çš„å…ƒç´ å‡ºç°

### å…¶ä»–

çŸ¥ä¹çš„é‚£ç¯‡æ–‡ç« è®²äº†å¾ˆå¤šçš„åº”ç”¨æ–¹å¼ï¼Œä¸å¾—ä¸è¯´è¿™ä¸ªå·¥å…·çœŸçš„æœ‰ç‚¹ç‰›é€¼ï¼Œåº”ç”¨å¾—å½“å¯ä»¥ç»™ä¸€äº›åŠŸèƒ½çš„æ€§èƒ½å¸¦æ¥ç›¸å½“å¤§çš„æå‡ã€‚åªä¸è¿‡ç›®å‰æˆ‘ä»¬ä¹Ÿå°±è¸©äº†å¯¼å‡ºå›¾ç‰‡è¿™ä¸€ä¸ªå‘è€Œå·²ã€‚