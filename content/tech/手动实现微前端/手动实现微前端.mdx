---
categories: tech
description: é€šè¿‡æ‰‹åŠ¨å®ç°ç®€æ˜“çš„å¾®å‰ç«¯ï¼Œæ¥å­¦ä¹ å¦‚ä½•ä½¿ç”¨å·²æœ‰çš„å¾®å‰ç«¯è§£å†³æ–¹æ¡ˆã€‚
date: 2022-10-13 00:44:59
title: æ‰‹åŠ¨å®ç°å¾®å‰ç«¯
tags: [æ¶æ„]
---

## æ–‡ç« çš„ç›®çš„

> æ‰‹é‡Œçš„å·¨çŸ³åº”ç”¨è¶Šæ¥è¶Šå¤§äº†ï¼Œæ˜¯æ—¶å€™æ€è€ƒæ€ä¹ˆç”¨å¾®å‰ç«¯æ¥æ”¹é€ äº†ã€‚
>
> æœ¬ç¯‡æ–‡ç« åº”è¯¥åªèƒ½ç®—æ˜¯å­¦ä¹ ç¬”è®°ï¼Œåªæœ‰ä¸€ä¸ªç›®çš„ï¼Œå°±æ˜¯é€šè¿‡è‡ªå·±åŠ¨æ‰‹åšä¸€ä¸ªè‡ªè¡Œè½¦ï¼Œè®©è‡ªå·±æ›´æ·±å…¥åœ°äº†è§£å¥”é©°çš„åŸç† ğŸ¤ªã€‚

é¦–å…ˆæ˜¯é©¬ä¸è€çˆ·å­ç½‘ç«™çš„æ–‡ç« [micro-frontends](https://martinfowler.com/articles/micro-frontends.html)ï¼Œè¿™ç¯‡æ–‡ç« è¯¦ç»†åˆ†æäº†å¾®å‰ç«¯çš„åŸç†å’Œ pros & consã€‚æˆ‘å°±ä¸æ‹¾äººç‰™æ…§äº†ã€‚

é˜¿é‡Œä¹¾å¤çš„æ–‡ç« ï¼š[å¾®å‰ç«¯çš„æ ¸å¿ƒä»·å€¼](https://www.yuque.com/kuitos/gky7yw/rhduwc)

[äº¬ä¸œå¼€æº-micro-app](https://zeroing.jd.com/micro-app/docs.html#/)

[qiankun](https://qiankun.umijs.org/zh/guide)

è¦å®ç°ä¸€ä¸ªå«å¾®å‰ç«¯çš„ä¸œè¥¿ï¼Œé¦–å…ˆè¦å®šä¹‰å®ƒï¼šå¤šä¸ªå‰ç«¯ APP è¿è¡ŒåŒæ—¶è¿è¡Œåœ¨ä¸€ä¸ªç½‘é¡µä¸Š

ç›®å‰æƒ³åˆ°çš„éœ€è¦ææ¸…æ¥šçš„é—®é¢˜ï¼š

1. æ ·å¼éš”ç¦»
2. JS éš”ç¦»
3. è·¨åº”ç”¨é€šä¿¡
4. æ¯ä¸ª app å¯ä»¥ç‹¬ç«‹ç»´æŠ¤å’Œéƒ¨ç½²

## æ–°å»º MFE monorepo

éœ€è¦ä¸¤ä¸ª moduleï¼Œä¸€ä¸ªå®¹å™¨ appï¼Œä¸€ä¸ªè¿œç¨‹ remote appï¼Œé¡¹ç›®é‡‡ç”¨ NX monorepoã€‚

> å¯¹ SPA å¾®å‰ç«¯æ¥è¯´ monorepo æ˜¯ä¸€ç§å¾ˆå¥½çš„ä»£ç ç®¡ç†æ¨¡å‹ï¼Œå› ä¸ºå¾®å‰ç«¯çš„ä¸åŒ APP è¿˜æ˜¯è¿è¡Œåœ¨åŒä¸€ä¸ªç½‘é¡µä¸Šï¼Œè®©ä»–ä»¬çš„ä»£ç å…±äº«ä¼šæ¯” multi repos å„è‡ªä¸ºæˆ˜æ›´å¥½

ä»å¤´å¼€å§‹æ’¸ã€‚

**å®‰è£… nx cli**

```shell
npm i -g @nrwl/cli
```

> å¦‚æœå®‰è£…è¿‡åè·‘ nx å‘½ä»¤å¾—åˆ°`zsh: command not found: nx`, æŒ‰ç…§è¿™ä¸ªæŒ‡å¼•é‡æ–°å®‰è£…ä¸€ä¸‹ nxï¼š [zsh: command not found: nx](https://stackoverflow.com/questions/65069128/zsh-command-not-found-nx)

**æ–°å»º NX å·¥ä½œåŒº**

```shell
npx create-nx-workspace --preset=empty mfe-demo
cd mfe-demo
```

**å®‰è£… NX çš„ react æ’ä»¶**

```shell
yarn add -D @nrwl/react
```

**æ–°å»ºå®¹å™¨ app**

```shell
nx g @nrwl/react:app shell
```

**æ–°å»º remote å­ APP**

```shell
nx g @nrwl/react:app remote
```

**ä½¿ç”¨[å¼‚æ­¥è¾¹ç•Œ](https://webpack.docschina.org/concepts/module-federation/#Uncaught-Error-Shared-module-is-not-available-for-eager-consumption)(asynchronous boundary)æŠŠåˆå§‹åŒ–ä»£ç æ‹†åˆ†æˆæ›´å¤§çš„å—**

æŠŠ `/apps/shell/src/main.tsx`æ”¹åæˆ`/apps/shell/src/bootstrap.tsx`

ç„¶åæ–°å¢ `index.ts`:

```ts
import('./bootstrap');
```

ä¿®æ”¹ nx é…ç½®æ–‡ä»¶`/apps/shell/project.json`

```json
...
options: {
  ...
   // "main": "apps/test/src/main.tsx",
  "main": "apps/test/src/index.ts"
}
```

å¯¹ remote app åšç›¸åŒçš„äº‹ã€‚

### é…ç½® module-federation æ’ä»¶

å‚è€ƒ webpack5 [module-federation æ–‡æ¡£](https://webpack.js.org/concepts/module-federation/)

ä¿®æ”¹`/apps/shell/project.json`

```json
 "targets": {
    "build": {
      "options": {
        // "webpackConfig": "@nrwl/react/plugins/webpack"
        "webpackConfig": "apps/shell/webpack.config.js"
      },
```

shell ç›®å½•ä¸‹æ–°å»ºè‡ªå®šä¹‰ webpack é…ç½®

`webpack.config.js`

```js
const { ModuleFederationPlugin } = require('webpack').container;
const deps = require('../../package.json').dependencies;

module.exports = (config, context) => {
  return {
    ...config,
    devServer: {
      ...config.devServer,
      // HACK ALERT: during async module loading, webpack will try to load the remote entry from http://localhost:3000
      // and when it is not ready, it will start to redirect to http://localhost:5000 (local address) and throw the error,
      // We need to force compiler to resolve the remote script strictly from remote host http://localhost:3000.
      proxy: {
        'http://localhost:3000': 'http://localhost:3000',
      },
    },
    plugins: [
      ...config.plugins,
      new ModuleFederationPlugin({
        name: 'shell',
        remotes: {
          remote: 'remote@http://localhost:3000/remoteEntry.js',
        },
        shared: {
          ...deps,
          react: { singleton: true, eager: true, requiredVersion: deps.react },
          'react-dom': {
            singleton: true,
            eager: true,
            requiredVersion: deps['react-dom'],
          },
        },
      }),
    ],
  };
};
```

å¯¹ remote appï¼Œç±»ä¼¼ shell ä¸€æ ·ä¿®æ”¹`package.json`, æ–°å¢`webpack.config.js`

```js
const { ModuleFederationPlugin } = require('webpack').container;
const deps = require('../../package.json').dependencies;

module.exports = (config, context) => {
  return {
    ...config,
    plugins: [
      ...config.plugins,
      new ModuleFederationPlugin({
        name: 'remote',
        filename: 'remoteEntry.js',
        exposes: {
          './App': './src/app/app',
        },
        shared: {
          ...deps,
          react: {
            singleton: true,
            eager: true,
            requiredVersion: deps.react,
          },
          'react-dom': {
            singleton: true,
            eager: true,
            requiredVersion: deps['react-dom'],
          },
        },
      }),
    ],
  };
};
```

### è¿è¡Œ Shell APP

**åœ¨ shell ä¸­å®‰è£… remote app**

`apps/shell/src/app.tsx`

```tsx
import { Suspense, lazy } from 'react';

const RemoteApp = lazy(() => import('remote/App'));

export function App() {
  return (
    <>
      Shell App
      <Suspense fallback={<div>Loading...</div>}>
        <RemoteApp />
      </Suspense>
    </>
  );
}

export default App;
```

**ä¿®æ”¹è¿è¡Œè„šæœ¬**

shell ä¼šå» localhost:3000 æ‹¿æ‰“åŒ…è¿‡åçš„ remote ä»£ç ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹ä¸€ä¸‹ serve è„šæœ¬

æœ€å¤–å±‚ package.json

```json
{
  ...
  "scripts": {
        "start:shell": "nx serve --project=shell --port=4999",
    		"start:remote": "nx serve --project=remote --port=3000",
    		"start:all": "yarn start:shell & yarn start:remote"
  }
}
```

**è¿è¡Œè„šæœ¬**

```shell
yarn start:all
```

è®¿é—®`localhost:4999`å¯ä»¥çœ‹åˆ°å¾®å‰ç«¯æœ¬åœ°åº”ç”¨æ­£å¸¸è¿è¡Œã€‚

### NX å†…éƒ¨çš„å°è£…

NX å·²ç»æœ‰ä¸é”™çš„ MFE starter äº†ã€‚[NX/react-module-federation](https://github.com/nrwl/react-module-federation)

Nx æä¾›äº†ä¸€ä¸ªå°è£…å¥½çš„`withModuleFederation`ï¼Œå¯ä»¥æ–¹ä¾¿åœ°[fast build micro front end](https://nx.dev/recipe/faster-builds#summary)

`withModuleFederation`æºç ï¼š[nx repo](https://github.com/nrwl/nx/blob/master/packages/react/src/module-federation/with-module-federation.ts)ï¼Œè¿™ä¸ªæ’ä»¶å°è£…äº† NX è‡ªå·±çš„ç¼“å­˜é…ç½®ï¼Œä»¥åŠ`ModuleFederationPlugin`çš„é…ç½®ç»†èŠ‚ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ‰‹åŠ¨æ·»åŠ é…ç½®ç»†èŠ‚äº†ã€‚

åœ¨ä¸Šé¢çš„æ‰‹åŠ¨å®ç°çš„æ­¥éª¤ä¸­æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨ç»™ remote app æŒ‡å®šç«¯å£ï¼Œç„¶åéœ€è¦è·‘æ‰€æœ‰çš„ serve è„šæœ¬ã€‚

å€ŸåŠ© Nx çš„ `@nrwl/react:module-federation-dev-server`æ‰§è¡Œå™¨, æˆ‘ä»¬å¯ä»¥åœ¨ project.json é‡Œé¢å®šä¹‰ dev server çš„ç«¯å£

Remote app çš„ project.jsonï¼š

```json
...
"target": {
	...
  "serve": {
        "executor": "@nrwl/react:module-federation-dev-server",
        "defaultConfiguration": "development",
        "options": {
          "buildTarget": "remote:build",
          "hmr": true,
          "port": 4201
        },
        "configurations": {
          "development": {
            "buildTarget": "remote:build:development"
          },
          "production": {
            "buildTarget": "remote:build:production",
            "hmr": false
          }
        }
      },
}
```

### ç›´æ¥ç”¨ Nx ç”Ÿæˆå¾®å‰ç«¯é¡¹ç›®

ä»¥ä¸Šçš„å®ç°ç»†èŠ‚å®é™…ä¸Š Nx å·²ç»å°è£…äº†ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ç›¸å…³å‘½ä»¤ç”Ÿæˆå¾®å‰ç«¯é¡¹ç›®ï¼Œæ‰€ä»¥å‰é¢ä¸‰èŠ‚å†…å®¹åœ¨å®é™…å·¥ä½œä¸­å¯ä»¥çœç•¥ã€‚

æ–°å»ºä¸€ä¸ªå¾®å‰ç«¯é¡¹ç›®ï¼š

```shell
nx g @nrwl/react:host shell --remotes=remote1,remote2
```

ç”Ÿæˆçš„é¡¹ç›®è‡ªåŠ¨é…å¥½äº†`webpack.config.js`å’Œ`project.json`ï¼Œå¹¶ä¸”é»˜è®¤çš„`defaultProject`æ˜¯ shell app

æœ€å¤–å±‚ package.json

```json
...
"scripts": {
    "start": "nx serve",
    "build": "nx build",
    "test": "nx test"
  },
```

æœ¬åœ°æµ‹è¯•

```shell
# æœ¬åœ°æµ‹è¯•é¡¹ç›®
npm start
# æ‰“åŒ…ä»£ç 
npm build
```

### æ‰“åŒ…

åœ¨ä¸Šä¸€æ­¥æˆ‘ä»¬æœ¬åœ°æµ‹è¯•æ²¡é—®é¢˜è¿‡åå¯ä»¥é€‰æ‹©æ‰“åŒ…ä»£ç ã€‚æœ¬åœ°æµ‹è¯•çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„ App éƒ½è·‘åœ¨ localhost ä¹‹ä¸‹ï¼Œåœ¨ NX ä¸­ï¼Œç«¯å£æ˜¯åœ¨ project.json ä¸­è®¾ç½®çš„ï¼š

```json
...
 "serve": {
      "executor": "@nrwl/react:module-federation-dev-server",
      "defaultConfiguration": "development",
      "options": {
        "buildTarget": "shell:build",
        "hmr": true,
        // æœ¬åœ°serverçš„ç«¯å£
        "port": 4200
      },
	}
```

å®é™…éƒ¨ç½²è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦é€‰æ‹©å°†ä¸åŒçš„ App éƒ¨ç½²åˆ°ä¸åŒçš„åŸŸåä¸‹ã€‚è¿™æ—¶å€™éœ€è¦ç»™ shell App æŒ‡å®šç›¸åº”çš„ remote url

webpack.config.prod.js

```js
const { withModuleFederation } = require('@nrwl/react/module-federation');
const baseConfig = require('./module-federation.config');

const prodConfig = {
  ...baseConfig,
  /*
   * Remote overrides for production.
   * Each entry is a pair of an unique name and the URL where it is deployed.
   *
   * e.g.
   * remotes: [
   *   ['app1', '//app1.example.com'],
   *   ['app2', '//app2.example.com'],
   * ]
   *
   * You can also use a full path to the remoteEntry.js file if desired.
   *
   * remotes: [
   *   ['app1', '//example.com/path/to/app1/remoteEntry.js'],
   *   ['app2', '//example.com/path/to/app2/remoteEntry.js'],
   * ]
   */
  remotes: [['remote', '//myRemotesApp/']],
};

module.exports = withModuleFederation(prodConfig);
```

æ‰“åŒ…åçš„ç»“æ„

```
dist
  â””â”€â”€ apps
      â”œâ”€â”€ remote
      â”œâ”€â”€ shell
```

OKï¼Œæˆ‘ä»¬é¡ºåˆ©åœ°åœ¨ä¸€ä¸ªç½‘é¡µä¸Šè¿è¡Œäº†ä¸¤ä¸ª APPï¼Œå¾®å‰ç«¯ so easyï¼Œä¸‹é¢å°±æ˜¯ä¸€äº›â€œæ— å…³ç´§è¦â€çš„æŠ€æœ¯ç»†èŠ‚äº†ã€‚

## æ ·å¼éš”ç¦»

**æ ·å¼ç©¿é€**

çˆ¶åº”ç”¨çš„å…¨å±€æ ·å¼æ±¡æŸ“å­åº”ç”¨ã€‚ç©¿é€çš„åŸå› å¾ˆå¤šï¼Œå¸¸è§çš„ä¸¤ç§æƒ…å†µ

1. çˆ¶åº”ç”¨ç›´æ¥ä¿®æ”¹äº†æ ‡ç­¾çš„é»˜è®¤æ ·å¼

   ```css
   p {
     margin: 1rem;
   }
   ```

2. çˆ¶åº”ç”¨ä½¿ç”¨äº†`!important`

**æ ·å¼è¦†ç›–**

å­åº”ç”¨ç±»åä¼šè¦†ç›–çˆ¶åº”ç”¨çš„ç±»åã€‚

å¦‚æœæˆ‘ä»¬çš„ç›®çš„åªæ˜¯ç”¨å¾®å‰ç«¯æ‹†åˆ†å·¨çŸ³åº”ç”¨è€Œä¸æ˜¯è¦è®©å„ App äº’ä¸è€¦åˆå®Œå…¨ä¸å½±å“å½¼æ­¤ï¼Œé‚£ä¹ˆå°±å¯ä»¥å‡è®¾ä¸» App å’Œå­ App å›¢é˜Ÿä¹‹é—´æœ‰æ²Ÿé€šï¼Œçˆ¶ App çš„ä¸€äº›å…¨å±€æ ·å¼å’Œæ ·å¼ç©¿é€æ˜¯å¯ä»¥æ¥å—çš„ã€‚

å¯¹äºæ ·å¼çš„è¦†ç›–ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆè‡ªç„¶åœ°æƒ³åˆ°åŠ å‰ç¼€ã€‚å‚è€ƒ [ä»é›¶å¼€å§‹å†™ä¸€ä¸ªå¾®å‰ç«¯æ¡†æ¶-æ ·å¼éš”ç¦»ç¯‡](https://github.com/micro-zoe/micro-app/issues/20)

å¦‚æœé¡¹ç›®æ˜¯ç”¨çš„ css module æˆ–è€… css-in-js åº“ï¼ˆstyled-component ä¹‹ç±»çš„ï¼‰ï¼Œå°±ä¸ç”¨å¤ªå…³æ³¨è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºæ¯ä¸ªç±»é€‰æ‹©å™¨çš„åå­—éƒ½åŠ ä¸Šäº†å”¯ä¸€çš„çŸ­å“ˆå¸Œã€‚

## JS éš”ç¦»

[ä»é›¶å¼€å§‹å†™ä¸€ä¸ªå¾®å‰ç«¯æ¡†æ¶-æ²™ç®±ç¯‡](https://github.com/micro-zoe/micro-app/issues/19)

ğŸ˜… è¿™ä¸ªç³»åˆ—å†™çš„çœŸçš„ä¸é”™ã€‚ã€‚ç•™ä¸ªé“¾æ¥ã€‚

JS æ²™ç®±çš„ç›®çš„æ˜¯è®©å­åº”ç”¨å’ŒåŸºåº§åº”ç”¨å®Œå…¨è§£è€¦ã€‚

å¦‚æœåªæ˜¯æŒ‰ç…§ä¸åŒçš„åŠŸèƒ½åŒºå’Œè´¡çŒ®å›¢é˜Ÿæ¥åˆ†ç¦»å·¨çŸ³åº”ç”¨ï¼Œå®é™…ä¸Š JS æ²™ç®±çš„éœ€æ±‚å¹¶ä¸å¤§ã€‚å› ä¸ºå¹¶æ²¡æœ‰ APP çš„æ’å¸éœ€æ±‚ï¼Œå­åº”ç”¨å…±ç”¨ä¸€ä¸ª window å¯¹è±¡æ˜¯å¯ä»¥æ¥å—çš„ã€‚

## è·¨åº”ç”¨é€šä¿¡

ä¸åŒäº iframeï¼Œå•é¡µå¾®å‰ç«¯çš„æ‰€æœ‰ app è¿˜æ˜¯ç›´æ¥ä»å…¨å±€å˜é‡é‡Œæ‹¿åˆ°å…¨å±€çŠ¶æ€ã€‚

æ‰¾äº†ä¸‹èµ„æ–™ï¼Œä¹¾å¤å’Œå…¶ä»–å¾®å‰ç«¯æ¡†æ¶åœ¨æ•°æ®é€šä¿¡è¿™ä¸€å—éƒ½æ˜¯ç”¨çš„å‘å¸ƒè®¢é˜…è€…æ¨¡å¼ï¼Œå¸¸è§çš„ event bus

[ä»é›¶å¼€å§‹å†™ä¸€ä¸ªå¾®å‰ç«¯æ¡†æ¶-æ•°æ®é€šä¿¡ç¯‡](https://github.com/micro-zoe/micro-app/issues/21)

## æš‚æ—¶å…ˆå†™åˆ°è¿™é‡Œé‡åˆ°å‘äº†å†æ…¢æ…¢è®°å½•
